<!doctype html>
<html ng-app="app">
    <head>
        <title>hello</title>
    </head>
    <body ng-controller="AppController">
        <button ng-click="goAhead()">Go Ahead</button>
        <button ng-click="goCreateRoom()">Go Create Room</button>

        <ul>
            <li ng-repeat="room in rooms">({{room.id}}) <input type="text" ng-model="room.name"> <button type="button" ng-click="editRoom(room)">Save</button> <button type="button" ng-click="deleteRoom(room.id)">Delete</button></li>
        </ul>

        <script src="http://cdn.jsdelivr.net/sockjs/1.0.3/sockjs.min.js"></script>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.5/angular.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.5/angular-route.min.js"></script>
        <script src="https://rawgit.com/beevelop/ng-stomp/master/ng-stomp.min.js"></script>
        <script>
            angular.module('app', ['ngStomp'])
            .controller('AppController', function($scope, $http, $stomp/*notificationService*/) {
                $scope.rooms = [];

                /*$scope.goAhead = function() {
                    var socket = new SockJS('/ws');
                    var stompClient = Stomp.over(socket);
                    stompClient.connect({}, function(frame) {
                        console.log('connected: ', frame);

                        stompClient.subscribe('/notifications', function(notification) {
                            console.log('got notification:', notification);
                            var body = JSON.parse(notification.body);
                            console.log('parsed as:', body);
                        });

                        stompClient.send('/app/createUser', {}, JSON.stringify({
                            name: 'user-' + Math.random().toString(36).replace(/[^a-z]+/g, '').substr(0, 5)
                        }));
                    });
                };*/

                // https://github.com/davinkevin/AngularStompDK - give this one a try

                $stomp.connect('/ws', {}).then(function(frame) {
                    var subscription = $stomp.subscribe('/notifications', function(payload, headers, res) {
                        var notification = payload;
                        console.log('got notification', notification);

                        var eventType = notification.type;
                        if(eventType === 'roomCreated') {
                            console.log('ROOM CREATED!!!');
                            $scope.rooms.push({
                                id: notification.id,
                                name: notification.name
                            });
                        } else if(eventType === 'roomUpdated') {
                            console.log('ROOM UPDATED!!!');
                            var room = $scope.rooms.find(function(r) { return r.id === notification.id; });
                            room.name = notification.name;
                        } else if(eventType === 'roomDeleted') {
                            console.log('ROOM DELETED!!!');
                            var index = $scope.rooms.findIndex(function(r) { return r.id === notification.id; });
                            $scope.rooms.splice(index, 1);
                        } else {
                            console.log('unknown event type:', eventType);
                        }

                        $scope.$digest();
                    });

                    // $subscription.unsubscribe()
                    // $stomp.send()
                    // $stomp.disconnect();
                });

                $scope.goCreateRoom = function() {
                    $http.post('/api/rooms', {
                        name: 'test room #' + Math.random().toString(36).replace(/[^a-z]+/g, '').substr(0, 5)
                    }).then(function(response) {
                        console.log('response', response);
                    });
                };

                $scope.deleteRoom = function(roomId) {
                    $http.delete('/api/rooms/' + roomId).then(function(response) {
                        console.log('response', response);
                    });
                };

                $scope.editRoom = function(room) {
                    $http.put('/api/rooms/' + room.id, {
                        name: room.name
                    }).then(function(response) {
                        console.log('response', response);
                    });
                };
            });
        </script>
    </body>
</html>
